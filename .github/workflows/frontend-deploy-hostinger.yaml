name: Deploy to Hostinger

on:
  push:
    branches: [main]

jobs:
  lint-and-build:
    name: ğŸ§ª Lint & Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        name: ğŸ“¥ Checkout repository

      - uses: actions/setup-node@v4
        with: { node-version: 20 }
        name: ğŸ§° Setup Node.js

      - uses: pnpm/action-setup@v3
        with: { version: latest }
        name: ğŸ§° Setup pnpm

      - name: ğŸ“¦ Install project dependencies
        run: pnpm install --no-frozen-lockfile

      - name: ğŸ§¹ Run ESLint
        run: pnpm lint || echo "Lint errors found but continuing"

      - name: ğŸ”¨ Build app
        run: pnpm build

  deploy:
    name: ğŸš€ Deploy to Hostinger
    runs-on: ubuntu-latest
    needs: lint-and-build
    steps:
      - uses: actions/checkout@v4
        name: ğŸ“¥ Checkout repository

      - uses: actions/setup-node@v4
        with: { node-version: 20 }
        name: ğŸ§° Setup Node.js

      - uses: pnpm/action-setup@v3
        with: { version: latest }
        name: ğŸ§° Setup pnpm

      - name: ğŸ“¦ Install project dependencies
        run: pnpm install --no-frozen-lockfile

      - name: ğŸ”¨ Build app
        run: pnpm build

      - name: ğŸ” Inspect built files
        run: ls -la ./out

      - name: ğŸ“¤ Upload to Hostinger via FTP
        env:
          H_HOSTINGER_USERNAME: ${{ secrets.HOSTINGER_USERNAME }}
          H_HOSTINGER_PASSWORD: ${{ secrets.HOSTINGER_PASSWORD }}
          H_HOSTINGER_DOMAIN: ${{ secrets.HOSTINGER_DOMAIN }}
        run: |
          sudo apt-get update
          sudo apt-get install -y lftp

          echo "ğŸ“¡ Conectando al servidor FTP"

          # Lista de carpetas a preservar
          EXCLUDE_DIRS="--exclude v1/ --exclude v2/ --exclude filemanager/"

          lftp -d -u "$H_HOSTINGER_USERNAME","$H_HOSTINGER_PASSWORD" "$H_HOSTINGER_DOMAIN" <<EOF
            set ftp:ssl-allow no
            
            # Primero cambiamos al directorio public_html
            cd public_html
            
            # Listamos el contenido para verificar
            ls -la
            
            # Usamos mirror con --delete-first, pero excluyendo las carpetas v1 y v2
            mirror -R --delete-first --verbose $EXCLUDE_DIRS ./out/ ./
            
            # Listamos de nuevo para comprobar el resultado
            ls -la
            
            bye
          EOF

          echo "âœ… Â¡Deploy a Hostinger finalizado!"
